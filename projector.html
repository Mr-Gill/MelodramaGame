<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Melodrama Werewolf - Projector View</title>
  <meta name="description" content="Student-facing display for Melodrama Werewolf game." />
  <!-- Google Fonts for theme-specific typography -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;700&family=Cinzel:wght@400;700&family=Orbitron:wght@400;700&family=Rye&family=Pirata+One&family=Lobster&family=Creepster&family=Montserrat:wght@400;600&display=swap" rel="stylesheet">
  <style>
    :root {
      --bg-primary: #0f172a;
      --bg-secondary: #1e293b;
      --text-primary: #f8fafc;
      --text-secondary: #e2e8f0;
      --accent-night: #7c3aed;
      --accent-day: #f59e0b;
      --accent-eliminated: #ef4444;
      --accent-timer: #22d3ee;
      font-family: "Inter", system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      font-size: 18px;
    }

    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      padding: 0;
      background: radial-gradient(circle at top, rgba(124, 58, 237, 0.15), transparent 60%), var(--bg-primary);
      color: var(--text-primary);
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }

    header {
      padding: 2rem clamp(2rem, 5vw, 4rem);
      text-align: center;
      border-bottom: 2px solid rgba(148, 163, 184, 0.2);
      background: rgba(15, 23, 42, 0.8);
      backdrop-filter: blur(10px);
    }

    header h1 {
      margin: 0 0 0.5rem 0;
      font-size: clamp(2.5rem, 6vw, 4.5rem);
      letter-spacing: 0.05em;
      text-shadow: 0 0 30px rgba(124, 58, 237, 0.6);
    }

    header .subtitle {
      font-size: clamp(1.1rem, 2.5vw, 2rem);
      color: var(--text-secondary);
      letter-spacing: 0.1em;
      text-transform: uppercase;
      font-weight: 500;
    }

    main {
      flex: 1;
      display: grid;
      grid-template-rows: auto 1fr auto;
      gap: 2rem;
      padding: 3rem clamp(2rem, 5vw, 4rem);
      max-width: 1800px;
      width: 100%;
      margin: 0 auto;
    }

    .phase-indicator {
      text-align: center;
      padding: 2rem;
      border-radius: 24px;
      background: rgba(15, 23, 42, 0.7);
      border: 3px solid;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.4);
      animation: pulse-glow 3s ease-in-out infinite;
    }

    .phase-indicator.night {
      border-color: var(--accent-night);
      box-shadow: 0 0 60px rgba(124, 58, 237, 0.5);
    }

    .phase-indicator.day {
      border-color: var(--accent-day);
      box-shadow: 0 0 60px rgba(245, 158, 11, 0.5);
    }

    @keyframes pulse-glow {
      0%, 100% {
        transform: scale(1);
        opacity: 1;
      }
      50% {
        transform: scale(1.02);
        opacity: 0.95;
      }
    }

    .phase-label {
      font-size: clamp(1.5rem, 4vw, 3rem);
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.15em;
      margin: 0 0 0.5rem 0;
    }

    .night-number {
      font-size: clamp(1.3rem, 3vw, 2.2rem);
      color: var(--text-secondary);
      letter-spacing: 0.08em;
      font-weight: 500;
    }

    .main-display {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 2rem;
      align-items: start;
    }

    @media (max-width: 1024px) {
      .main-display {
        grid-template-columns: 1fr;
      }
    }

    .timer-card {
      background: rgba(15, 23, 42, 0.85);
      border-radius: 28px;
      padding: 3rem;
      text-align: center;
      border: 2px solid rgba(34, 211, 238, 0.3);
      box-shadow: 0 20px 50px rgba(0, 0, 0, 0.4);
    }

    .timer-label {
      font-size: clamp(1.3rem, 2.5vw, 2.2rem);
      color: var(--text-secondary);
      text-transform: uppercase;
      letter-spacing: 0.1em;
      margin-bottom: 1rem;
      font-weight: 600;
    }

    .timer-display {
      font-size: clamp(4rem, 12vw, 9rem);
      font-weight: 700;
      letter-spacing: 0.1em;
      color: var(--accent-timer);
      text-shadow: 0 0 40px rgba(34, 211, 238, 0.6);
      line-height: 1;
      margin: 0;
      font-variant-numeric: tabular-nums;
    }

    .timer-display.warning {
      color: var(--accent-day);
      text-shadow: 0 0 40px rgba(245, 158, 11, 0.6);
      animation: pulse-urgent 1s ease-in-out infinite;
    }

    .timer-display.critical {
      color: var(--accent-eliminated);
      text-shadow: 0 0 40px rgba(239, 68, 68, 0.8);
      animation: pulse-urgent 0.5s ease-in-out infinite;
    }

    @keyframes pulse-urgent {
      0%, 100% {
        transform: scale(1);
      }
      50% {
        transform: scale(1.05);
      }
    }

    .eliminated-card {
      background: rgba(15, 23, 42, 0.85);
      border-radius: 28px;
      padding: 3rem;
      border: 2px solid rgba(239, 68, 68, 0.3);
      box-shadow: 0 20px 50px rgba(0, 0, 0, 0.4);
      max-height: 600px;
      overflow-y: auto;
    }

    .eliminated-title {
      font-size: clamp(1.5rem, 3vw, 2.5rem);
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.1em;
      margin: 0 0 1.5rem 0;
      color: var(--accent-eliminated);
      text-shadow: 0 0 20px rgba(239, 68, 68, 0.4);
    }

    .eliminated-list {
      list-style: none;
      padding: 0;
      margin: 0;
      display: grid;
      gap: 1rem;
    }

    .eliminated-item {
      padding: 1.5rem 1.75rem;
      background: rgba(239, 68, 68, 0.18);
      border-radius: 16px;
      border-left: 4px solid var(--accent-eliminated);
      font-size: clamp(1.2rem, 2vw, 2rem);
      letter-spacing: 0.05em;
      animation: fade-in 0.5s ease-out;
      font-weight: 500;
    }

    @keyframes fade-in {
      from {
        opacity: 0;
        transform: translateY(-10px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .empty-message {
      font-size: clamp(1.2rem, 2vw, 1.8rem);
      color: var(--text-secondary);
      text-align: center;
      padding: 2rem;
      font-style: italic;
    }

    footer {
      text-align: center;
      padding: 2rem;
      color: var(--text-secondary);
      font-size: clamp(1rem, 1.5vw, 1.3rem);
      border-top: 1px solid rgba(148, 163, 184, 0.2);
    }

    .connection-status {
      position: fixed;
      top: 1rem;
      right: 1rem;
      padding: 0.75rem 1.25rem;
      border-radius: 999px;
      font-size: 0.9rem;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
      z-index: 1000;
    }

    .connection-status.connected {
      background: rgba(34, 197, 94, 0.2);
      border: 2px solid #22c55e;
      color: #86efac;
    }

    .connection-status.disconnected {
      background: rgba(239, 68, 68, 0.2);
      border: 2px solid #ef4444;
      color: #fca5a5;
    }

    .connection-status .indicator {
      display: inline-block;
      width: 10px;
      height: 10px;
      border-radius: 50%;
      margin-right: 0.5rem;
      animation: blink 2s ease-in-out infinite;
    }

    .connection-status.connected .indicator {
      background: #22c55e;
    }

    .connection-status.disconnected .indicator {
      background: #ef4444;
    }

    @keyframes blink {
      0%, 100% {
        opacity: 1;
      }
      50% {
        opacity: 0.4;
      }
    }

    /* Custom scrollbar */
    .eliminated-card::-webkit-scrollbar {
      width: 10px;
    }

    .eliminated-card::-webkit-scrollbar-track {
      background: rgba(15, 23, 42, 0.5);
      border-radius: 10px;
    }

    .eliminated-card::-webkit-scrollbar-thumb {
      background: rgba(239, 68, 68, 0.4);
      border-radius: 10px;
    }

    .eliminated-card::-webkit-scrollbar-thumb:hover {
      background: rgba(239, 68, 68, 0.6);
    }

    /* Theme-specific animations */
    @keyframes flicker {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.85; }
    }

    @keyframes shimmer {
      0%, 100% { filter: brightness(1); }
      50% { filter: brightness(1.15); }
    }

    @keyframes spotlight {
      0%, 100% { box-shadow: 0 0 30px rgba(245, 158, 11, 0.3); }
      50% { box-shadow: 0 0 50px rgba(245, 158, 11, 0.6); }
    }

    @keyframes tech-glow {
      0%, 100% { box-shadow: 0 0 20px rgba(34, 211, 238, 0.4); }
      50% { box-shadow: 0 0 40px rgba(34, 211, 238, 0.8); }
    }

    @keyframes dust {
      0%, 100% { opacity: 0.95; }
      50% { opacity: 0.85; }
    }

    @keyframes wave {
      0%, 100% { transform: translateY(0); }
      50% { transform: translateY(-3px); }
    }

    @keyframes heartbeat {
      0%, 100% { transform: scale(1); }
      25% { transform: scale(1.05); }
      50% { transform: scale(1); }
    }

    /* Fullscreen button */
    .fullscreen-btn {
      position: fixed;
      top: 1rem;
      left: 1rem;
      padding: 0.75rem 1.25rem;
      border-radius: 999px;
      font-size: 0.9rem;
      font-weight: 600;
      background: rgba(34, 211, 238, 0.2);
      border: 2px solid #22d3ee;
      color: #86efac;
      cursor: pointer;
      z-index: 1000;
      transition: all 0.2s ease;
    }

    .fullscreen-btn:hover {
      background: rgba(34, 211, 238, 0.4);
      transform: scale(1.05);
    }

    /* Player count stats */
    .player-stats {
      display: flex;
      gap: 2rem;
      justify-content: center;
      flex-wrap: wrap;
      margin-top: 1rem;
    }

    .stat-item {
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 1rem 1.5rem;
      border-radius: 16px;
      background: rgba(15, 23, 42, 0.7);
      border: 2px solid rgba(148, 163, 184, 0.3);
      min-width: 120px;
    }

    .stat-item.good {
      border-color: rgba(56, 189, 248, 0.5);
    }

    .stat-item.evil {
      border-color: rgba(244, 114, 182, 0.5);
    }

    .stat-value {
      font-size: clamp(2rem, 4vw, 3rem);
      font-weight: 700;
      line-height: 1;
    }

    .stat-item.good .stat-value {
      color: #38bdf8;
    }

    .stat-item.evil .stat-value {
      color: #f472b6;
    }

    .stat-label {
      font-size: clamp(0.9rem, 1.5vw, 1.2rem);
      color: var(--text-secondary);
      text-transform: uppercase;
      letter-spacing: 0.1em;
      margin-top: 0.5rem;
    }

    /* Win notification overlay */
    .win-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(15, 23, 42, 0.95);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 2000;
      backdrop-filter: blur(10px);
    }

    .win-overlay.active {
      display: flex;
    }

    .win-content {
      text-align: center;
      animation: win-appear 0.5s ease-out;
    }

    @keyframes win-appear {
      from {
        opacity: 0;
        transform: scale(0.8);
      }
      to {
        opacity: 1;
        transform: scale(1);
      }
    }

    .win-title {
      font-size: clamp(3rem, 10vw, 8rem);
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.1em;
      margin-bottom: 1rem;
      animation: win-pulse 1.5s ease-in-out infinite;
    }

    .win-title.good {
      color: #38bdf8;
      text-shadow: 0 0 60px rgba(56, 189, 248, 0.8);
    }

    .win-title.evil {
      color: #f472b6;
      text-shadow: 0 0 60px rgba(244, 114, 182, 0.8);
    }

    @keyframes win-pulse {
      0%, 100% {
        transform: scale(1);
      }
      50% {
        transform: scale(1.05);
      }
    }

    .win-subtitle {
      font-size: clamp(1.5rem, 4vw, 3rem);
      color: var(--text-secondary);
      letter-spacing: 0.15em;
    }

    .win-emoji {
      font-size: clamp(4rem, 12vw, 10rem);
      margin-bottom: 1rem;
    }

    /* Voting phase display */
    .voting-card {
      background: rgba(15, 23, 42, 0.85);
      border-radius: 28px;
      padding: 2rem;
      text-align: center;
      border: 3px solid rgba(244, 114, 182, 0.5);
      box-shadow: 0 20px 50px rgba(0, 0, 0, 0.4);
      display: none;
    }

    .voting-card.active {
      display: block;
      animation: pulse-voting 2s ease-in-out infinite;
    }

    @keyframes pulse-voting {
      0%, 100% {
        box-shadow: 0 0 30px rgba(244, 114, 182, 0.4);
      }
      50% {
        box-shadow: 0 0 60px rgba(244, 114, 182, 0.7);
      }
    }

    .voting-title {
      font-size: clamp(1.5rem, 3vw, 2.5rem);
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.1em;
      margin: 0 0 1rem 0;
      color: #f472b6;
      text-shadow: 0 0 20px rgba(244, 114, 182, 0.5);
    }

    .voting-phase-label {
      font-size: clamp(1.2rem, 2vw, 1.8rem);
      color: var(--text-secondary);
      margin-bottom: 1.5rem;
    }

    .nominated-list {
      list-style: none;
      padding: 0;
      margin: 0;
      display: grid;
      gap: 0.75rem;
    }

    .nominated-item {
      padding: 1rem 1.5rem;
      background: rgba(244, 114, 182, 0.15);
      border-radius: 12px;
      border-left: 4px solid #f472b6;
      font-size: clamp(1.1rem, 1.8vw, 1.6rem);
      letter-spacing: 0.05em;
      font-weight: 500;
      text-align: left;
    }

    .voting-instruction {
      margin-top: 1.5rem;
      font-size: clamp(1rem, 1.5vw, 1.4rem);
      color: var(--accent-timer);
      font-style: italic;
    }

    /* Player roster section */
    .roster-card {
      background: rgba(15, 23, 42, 0.85);
      border-radius: 28px;
      padding: 1.5rem;
      border: 2px solid rgba(148, 163, 184, 0.3);
      box-shadow: 0 20px 50px rgba(0, 0, 0, 0.4);
      display: none;
      max-height: 400px;
      overflow-y: auto;
    }

    .roster-card.active {
      display: block;
    }

    .roster-title {
      font-size: clamp(1.2rem, 2vw, 1.8rem);
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.1em;
      margin: 0 0 1rem 0;
      color: var(--text-primary);
      text-align: center;
    }

    .roster-list {
      list-style: none;
      padding: 0;
      margin: 0;
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
      gap: 0.5rem;
    }

    .roster-item {
      padding: 0.75rem 1rem;
      border-radius: 10px;
      font-size: clamp(0.9rem, 1.3vw, 1.2rem);
      display: flex;
      align-items: center;
      gap: 0.5rem;
      cursor: pointer;
      transition: all 0.2s ease;
      border: 2px solid transparent;
    }

    .roster-item:hover {
      transform: scale(1.02);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
    }

    .roster-item.good {
      background: rgba(56, 189, 248, 0.15);
      border-color: rgba(56, 189, 248, 0.4);
    }

    .roster-item.evil {
      background: rgba(244, 114, 182, 0.15);
      border-color: rgba(244, 114, 182, 0.4);
    }

    .roster-item.eliminated {
      opacity: 0.5;
      text-decoration: line-through;
    }

    .roster-item.eliminated::after {
      content: " ‚ò†Ô∏è";
    }

    .roster-name {
      flex: 1;
      font-weight: 500;
    }

    .roster-role {
      font-size: 0.85em;
      color: var(--text-secondary);
    }

    /* Character card modal */
    .character-modal {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(15, 23, 42, 0.95);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 3000;
      backdrop-filter: blur(10px);
    }

    .character-modal.active {
      display: flex;
    }

    .character-card {
      background: linear-gradient(135deg, rgba(30, 41, 59, 0.95), rgba(15, 23, 42, 0.98));
      border-radius: 24px;
      padding: 2.5rem;
      max-width: 600px;
      width: 90%;
      text-align: center;
      animation: card-appear 0.3s ease-out;
      border: 3px solid;
      box-shadow: 0 25px 80px rgba(0, 0, 0, 0.6);
    }

    .character-card.good {
      border-color: #38bdf8;
      box-shadow: 0 0 60px rgba(56, 189, 248, 0.4);
    }

    .character-card.evil {
      border-color: #f472b6;
      box-shadow: 0 0 60px rgba(244, 114, 182, 0.4);
    }

    @keyframes card-appear {
      from {
        opacity: 0;
        transform: scale(0.9) translateY(20px);
      }
      to {
        opacity: 1;
        transform: scale(1) translateY(0);
      }
    }

    .character-name {
      font-size: clamp(2rem, 4vw, 3rem);
      font-weight: 700;
      margin: 0 0 0.5rem 0;
      letter-spacing: 0.05em;
    }

    .character-card.good .character-name {
      color: #38bdf8;
      text-shadow: 0 0 30px rgba(56, 189, 248, 0.6);
    }

    .character-card.evil .character-name {
      color: #f472b6;
      text-shadow: 0 0 30px rgba(244, 114, 182, 0.6);
    }

    .character-type {
      font-size: clamp(1rem, 1.8vw, 1.4rem);
      color: var(--text-secondary);
      text-transform: uppercase;
      letter-spacing: 0.15em;
      margin-bottom: 1.5rem;
    }

    .character-team {
      display: inline-block;
      padding: 0.4rem 1rem;
      border-radius: 999px;
      font-size: clamp(0.9rem, 1.5vw, 1.2rem);
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.1em;
      margin-bottom: 1.5rem;
    }

    .character-team.good {
      background: rgba(56, 189, 248, 0.2);
      color: #38bdf8;
      border: 2px solid #38bdf8;
    }

    .character-team.evil {
      background: rgba(244, 114, 182, 0.2);
      color: #f472b6;
      border: 2px solid #f472b6;
    }

    .character-ability {
      font-size: clamp(1.2rem, 2vw, 1.6rem);
      color: var(--text-primary);
      line-height: 1.6;
      padding: 1.5rem;
      background: rgba(0, 0, 0, 0.3);
      border-radius: 16px;
      margin-bottom: 1.5rem;
    }

    .character-close {
      background: rgba(148, 163, 184, 0.3);
      border: 2px solid rgba(148, 163, 184, 0.5);
      color: var(--text-primary);
      padding: 0.75rem 2rem;
      border-radius: 999px;
      font-size: 1.1rem;
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .character-close:hover {
      background: rgba(148, 163, 184, 0.5);
      transform: scale(1.05);
    }

    /* Scrollbar for roster */
    .roster-card::-webkit-scrollbar {
      width: 8px;
    }

    .roster-card::-webkit-scrollbar-track {
      background: rgba(15, 23, 42, 0.5);
      border-radius: 8px;
    }

    .roster-card::-webkit-scrollbar-thumb {
      background: rgba(148, 163, 184, 0.4);
      border-radius: 8px;
    }

    .roster-card::-webkit-scrollbar-thumb:hover {
      background: rgba(148, 163, 184, 0.6);
    }
  </style>
</head>
<body>
  <!-- Character card modal -->
  <div class="character-modal" id="character-modal" onclick="hideCharacterCard(event)">
    <div class="character-card" id="character-card">
      <h2 class="character-name" id="character-name">Character Name</h2>
      <div class="character-type" id="character-type">Type</div>
      <div class="character-team" id="character-team-badge">Team</div>
      <div class="character-ability" id="character-ability">Ability description</div>
      <button class="character-close" onclick="closeCharacterModal()">Close</button>
    </div>
  </div>

  <!-- Win notification overlay -->
  <div class="win-overlay" id="win-overlay">
    <div class="win-content">
      <div class="win-emoji" id="win-emoji">üé≠</div>
      <div class="win-title" id="win-title">Victory!</div>
      <div class="win-subtitle" id="win-subtitle">The game has ended</div>
    </div>
  </div>

  <!-- Fullscreen button -->
  <button class="fullscreen-btn" id="fullscreen-btn" onclick="toggleFullscreen()">
    ‚õ∂ Fullscreen
  </button>

  <div class="connection-status disconnected">
    <span class="indicator"></span>
    <span class="status-text">Waiting for Narrator</span>
  </div>

  <header>
    <h1>üé≠ Melodrama Werewolf</h1>
    <div class="subtitle">Student View</div>
  </header>

  <main>
    <section class="phase-indicator night" id="phase-indicator">
      <div class="phase-label" id="phase-label">Setup</div>
      <div class="night-number" id="night-number">Preparing game...</div>
      <!-- Player stats -->
      <div class="player-stats" id="player-stats">
        <div class="stat-item">
          <span class="stat-value" id="alive-count">0</span>
          <span class="stat-label">Alive</span>
        </div>
        <div class="stat-item good">
          <span class="stat-value" id="good-count">0</span>
          <span class="stat-label">Good</span>
        </div>
        <div class="stat-item evil">
          <span class="stat-value" id="evil-count">0</span>
          <span class="stat-label">Evil</span>
        </div>
      </div>
    </section>

    <div class="main-display">
      <section class="timer-card">
        <div class="timer-label">Discussion Timer</div>
        <div class="timer-display" id="timer-display">03:00</div>
      </section>

      <!-- Player roster -->
      <section class="roster-card" id="roster-card">
        <h2 class="roster-title">üé≠ Characters in Play</h2>
        <ul class="roster-list" id="roster-list">
          <li class="empty-message">Waiting for game to start...</li>
        </ul>
      </section>

      <!-- Voting phase display -->
      <section class="voting-card" id="voting-card">
        <h2 class="voting-title">üó≥Ô∏è Voting Phase</h2>
        <div class="voting-phase-label" id="voting-phase-label">Nominations</div>
        <ul class="nominated-list" id="nominated-list">
          <li class="empty-message">No nominations yet</li>
        </ul>
        <div class="voting-instruction" id="voting-instruction">
          Point to the person you suspect!
        </div>
      </section>

      <section class="eliminated-card">
        <h2 class="eliminated-title">üíÄ Eliminated Players</h2>
        <ul class="eliminated-list" id="eliminated-list">
          <li class="empty-message">No one yet... but the drama is coming!</li>
        </ul>
      </section>
    </div>

    <footer>
      <div>Synchronized with Narrator View</div>
    </footer>
  </main>

  <script>
    // Theme definitions (matching narrator view)
    const THEMES = {
      village: {
        name: "Classic Village",
        visual: {
          background: "radial-gradient(circle at top, rgba(139, 92, 46, 0.15), transparent 60%), linear-gradient(180deg, #1a1410 0%, #2d1b0e 100%)",
          accentColor: "#d97706",
          textGlow: "0 0 10px rgba(217, 119, 6, 0.3)",
          cardBackground: "rgba(41, 37, 36, 0.6)",
          animation: "flicker 3s ease-in-out infinite",
          fontFamily: "'Georgia', 'Times New Roman', serif"
        }
      },
      mansion: {
        name: "Millionaire's Mansion",
        visual: {
          background: "radial-gradient(circle at center, rgba(234, 179, 8, 0.12), transparent 70%), linear-gradient(180deg, #1c1917 0%, #292524 100%)",
          accentColor: "#eab308",
          textGlow: "0 0 12px rgba(234, 179, 8, 0.4)",
          cardBackground: "rgba(68, 64, 60, 0.5)",
          animation: "shimmer 4s ease-in-out infinite",
          fontFamily: "'Playfair Display', 'Didot', serif"
        }
      },
      haunted: {
        name: "Haunted House",
        visual: {
          background: "radial-gradient(ellipse at bottom, rgba(124, 58, 237, 0.2), transparent 60%), linear-gradient(180deg, #0a0118 0%, #1e0b37 100%)",
          accentColor: "#a855f7",
          textGlow: "0 0 15px rgba(168, 85, 247, 0.5)",
          cardBackground: "rgba(30, 11, 55, 0.7)",
          animation: "pulse 2s ease-in-out infinite",
          fontFamily: "'Creepster', 'Courier New', monospace"
        }
      },
      castle: {
        name: "Castle Tower",
        visual: {
          background: "radial-gradient(circle at top, rgba(71, 85, 105, 0.2), transparent 65%), linear-gradient(180deg, #1e293b 0%, #334155 100%)",
          accentColor: "#64748b",
          textGlow: "0 0 8px rgba(100, 116, 139, 0.3)",
          cardBackground: "rgba(51, 65, 85, 0.6)",
          animation: "none",
          fontFamily: "'Cinzel', 'Trajan Pro', serif"
        }
      },
      theatre: {
        name: "Magic Show / Theatre",
        visual: {
          background: "radial-gradient(circle at center, rgba(239, 68, 68, 0.15), rgba(234, 179, 8, 0.1), transparent 70%), linear-gradient(180deg, #18181b 0%, #27272a 100%)",
          accentColor: "#f59e0b",
          textGlow: "0 0 20px rgba(245, 158, 11, 0.6)",
          cardBackground: "rgba(39, 39, 42, 0.7)",
          animation: "spotlight 5s ease-in-out infinite",
          fontFamily: "'Lobster', 'Brush Script MT', cursive"
        }
      },
      space: {
        name: "Space Station",
        visual: {
          background: "radial-gradient(circle at center, rgba(6, 182, 212, 0.2), rgba(34, 211, 238, 0.1), transparent 75%), linear-gradient(180deg, #020617 0%, #0c4a6e 100%)",
          accentColor: "#22d3ee",
          textGlow: "0 0 18px rgba(34, 211, 238, 0.7)",
          cardBackground: "rgba(12, 74, 110, 0.5)",
          animation: "tech-glow 3s ease-in-out infinite",
          fontFamily: "'Orbitron', 'Consolas', monospace"
        }
      },
      western: {
        name: "Wild West Town",
        visual: {
          background: "radial-gradient(circle at top, rgba(161, 98, 7, 0.2), transparent 60%), linear-gradient(180deg, #292524 0%, #44403c 100%)",
          accentColor: "#d97706",
          textGlow: "0 0 10px rgba(217, 119, 6, 0.4)",
          cardBackground: "rgba(68, 64, 60, 0.6)",
          animation: "dust 6s ease-in-out infinite",
          fontFamily: "'Rye', 'Rockwell', serif"
        }
      },
      pirate: {
        name: "Pirate Harbour",
        visual: {
          background: "radial-gradient(circle at bottom, rgba(14, 116, 144, 0.25), transparent 65%), linear-gradient(180deg, #0c4a6e 0%, #164e63 100%)",
          accentColor: "#06b6d4",
          textGlow: "0 0 12px rgba(6, 182, 212, 0.5)",
          cardBackground: "rgba(22, 78, 99, 0.6)",
          animation: "wave 4s ease-in-out infinite",
          fontFamily: "'Pirata One', 'Brush Script MT', cursive"
        }
      },
      hospital: {
        name: "Soap Opera Hospital",
        visual: {
          background: "radial-gradient(circle at top, rgba(56, 189, 248, 0.15), rgba(255, 255, 255, 0.05), transparent 70%), linear-gradient(180deg, #f8fafc 0%, #e2e8f0 100%)",
          accentColor: "#0ea5e9",
          textGlow: "0 0 10px rgba(14, 165, 233, 0.3)",
          cardBackground: "rgba(226, 232, 240, 0.8)",
          animation: "heartbeat 2s ease-in-out infinite",
          fontFamily: "'Montserrat', 'Helvetica Neue', sans-serif"
        }
      }
    };

    // BroadcastChannel for communication with narrator
    let channel = null;
    const CHANNEL_NAME = 'melodrama-narrator-projector';

    // State
    const state = {
      phase: 'setup',
      night: 0,
      timer: {
        remaining: 180,
        running: false
      },
      eliminated: [],
      connected: false,
      theme: 'village',
      aliveCount: 0,
      goodCount: 0,
      evilCount: 0,
      voting: {
        active: false,
        phase: null,
        nominations: []
      },
      roster: [] // Player roster with character info
    };

    // DOM elements
    const connectionStatus = document.querySelector('.connection-status');
    const statusText = document.querySelector('.status-text');
    const phaseIndicator = document.getElementById('phase-indicator');
    const phaseLabel = document.getElementById('phase-label');
    const nightNumber = document.getElementById('night-number');
    const timerDisplay = document.getElementById('timer-display');
    const eliminatedList = document.getElementById('eliminated-list');
    const aliveCountEl = document.getElementById('alive-count');
    const goodCountEl = document.getElementById('good-count');
    const evilCountEl = document.getElementById('evil-count');
    const winOverlay = document.getElementById('win-overlay');
    const winTitle = document.getElementById('win-title');
    const winSubtitle = document.getElementById('win-subtitle');
    const winEmoji = document.getElementById('win-emoji');
    const playerStats = document.getElementById('player-stats');
    const fullscreenBtn = document.getElementById('fullscreen-btn');
    const votingCard = document.getElementById('voting-card');
    const votingPhaseLabel = document.getElementById('voting-phase-label');
    const nominatedList = document.getElementById('nominated-list');
    const votingInstruction = document.getElementById('voting-instruction');
    const rosterCard = document.getElementById('roster-card');
    const rosterList = document.getElementById('roster-list');
    const characterModal = document.getElementById('character-modal');
    const characterCard = document.getElementById('character-card');
    const characterName = document.getElementById('character-name');
    const characterType = document.getElementById('character-type');
    const characterTeamBadge = document.getElementById('character-team-badge');
    const characterAbility = document.getElementById('character-ability');

    let timerHandle = null;

    function initBroadcastChannel() {
      if ('BroadcastChannel' in window) {
        try {
          channel = new BroadcastChannel(CHANNEL_NAME);
          
          channel.onmessage = (event) => {
            handleMessage(event.data);
            updateConnectionStatus(true);
          };

          channel.onmessageerror = (error) => {
            console.error('BroadcastChannel message error:', error);
          };

          // Request initial state
          setTimeout(() => {
            if (channel) {
              channel.postMessage({ type: 'request-state' });
            }
          }, 500);

          console.log('BroadcastChannel initialized');
        } catch (error) {
          console.error('Failed to initialize BroadcastChannel:', error);
          showFallbackMessage();
        }
      } else {
        console.warn('BroadcastChannel not supported');
        showFallbackMessage();
      }
    }

    function handleMessage(data) {
      console.log('Received message:', data);

      switch (data.type) {
        case 'phase-change':
          updatePhase(data.phase, data.night);
          break;
        
        case 'timer-update':
          updateTimer(data.remaining, data.running);
          break;
        
        case 'player-eliminated':
          addEliminated(data.playerName);
          break;
        
        case 'players-eliminated':
          setEliminated(data.players);
          break;
        
        case 'full-state':
          updateFullState(data);
          break;
        
        case 'reset-game':
          resetDisplay();
          break;
        
        case 'theme-change':
          updateTheme(data.theme);
          break;
        
        case 'WIN':
          showWinNotification(data.team, data.night);
          break;
        
        case 'player-counts':
          updatePlayerCounts(data.alive, data.good, data.evil);
          break;
        
        case 'voting-update':
          updateVotingDisplay(data.active, data.phase, data.nominations);
          break;
        
        case 'roster-update':
          updateRoster(data.players);
          break;
        
        case 'show-character':
          showCharacterCard(data.character);
          break;
      }
    }

    function updatePhase(phase, night) {
      state.phase = phase;
      state.night = night;
      
      phaseIndicator.className = `phase-indicator ${phase}`;
      
      if (phase === 'night') {
        phaseLabel.textContent = `üåô Night ${night}`;
        nightNumber.textContent = 'The village sleeps...';
      } else if (phase === 'day') {
        phaseLabel.textContent = `‚òÄÔ∏è Day ${night}`;
        nightNumber.textContent = 'Time to discuss and vote!';
      } else {
        phaseLabel.textContent = 'Setup';
        nightNumber.textContent = 'Preparing game...';
      }
    }

    function updateTimer(remaining, running) {
      state.timer.remaining = remaining;
      state.timer.running = running;
      
      renderTimer();
      
      if (running && !timerHandle) {
        startTimerDisplay();
      } else if (!running && timerHandle) {
        stopTimerDisplay();
      }
    }

    function startTimerDisplay() {
      if (timerHandle) clearInterval(timerHandle);
      
      timerHandle = setInterval(() => {
        if (state.timer.remaining > 0) {
          state.timer.remaining -= 1;
          renderTimer();
        } else {
          stopTimerDisplay();
        }
      }, 1000);
    }

    function stopTimerDisplay() {
      if (timerHandle) {
        clearInterval(timerHandle);
        timerHandle = null;
      }
    }

    function renderTimer() {
      const minutes = String(Math.floor(state.timer.remaining / 60)).padStart(2, '0');
      const seconds = String(state.timer.remaining % 60).padStart(2, '0');
      timerDisplay.textContent = `${minutes}:${seconds}`;
      
      // Update styling based on time remaining
      timerDisplay.classList.remove('warning', 'critical');
      if (state.timer.remaining <= 10) {
        timerDisplay.classList.add('critical');
      } else if (state.timer.remaining <= 30) {
        timerDisplay.classList.add('warning');
      }
    }

    function addEliminated(playerName) {
      if (!state.eliminated.includes(playerName)) {
        state.eliminated.push(playerName);
        renderEliminated();
      }
    }

    function setEliminated(players) {
      state.eliminated = [...players];
      renderEliminated();
    }

    function renderEliminated() {
      eliminatedList.innerHTML = '';
      
      if (state.eliminated.length === 0) {
        const empty = document.createElement('li');
        empty.className = 'empty-message';
        empty.textContent = 'No one yet... but the drama is coming!';
        eliminatedList.appendChild(empty);
      } else {
        state.eliminated.forEach(name => {
          const item = document.createElement('li');
          item.className = 'eliminated-item';
          item.textContent = name;
          eliminatedList.appendChild(item);
        });
      }
    }

    function updateFullState(data) {
      console.log('Received full state:', data);
      
      if (data.phase) {
        updatePhase(data.phase, data.night || 0);
      }
      
      if (data.timer) {
        updateTimer(data.timer.remaining, data.timer.running);
      }
      
      if (data.eliminated) {
        setEliminated(data.eliminated);
      }
      
      if (data.theme) {
        updateTheme(data.theme);
      }
      
      if (data.aliveCount !== undefined) {
        updatePlayerCounts(data.aliveCount, data.goodCount || 0, data.evilCount || 0);
      }
      
      if (data.roster) {
        updateRoster(data.roster);
      }
      
      updateConnectionStatus(true);
    }

    // Update player roster display
    function updateRoster(players) {
      state.roster = players || [];
      renderRoster();
    }

    function renderRoster() {
      rosterList.innerHTML = '';
      
      if (state.roster.length === 0) {
        const li = document.createElement('li');
        li.className = 'empty-message';
        li.textContent = 'Waiting for game to start...';
        rosterList.appendChild(li);
        rosterCard.classList.remove('active');
        return;
      }
      
      // Show roster card
      rosterCard.classList.add('active');
      
      // Sort: alive players first, then eliminated
      const sortedRoster = [...state.roster].sort((a, b) => {
        if (a.eliminated === b.eliminated) return 0;
        return a.eliminated ? 1 : -1;
      });
      
      sortedRoster.forEach(player => {
        const li = document.createElement('li');
        li.className = `roster-item ${player.team}${player.eliminated ? ' eliminated' : ''}`;
        li.innerHTML = `
          <span class="roster-name">${player.name}</span>
          <span class="roster-role">${player.roleName}</span>
        `;
        li.onclick = () => showCharacterCard(player);
        rosterList.appendChild(li);
      });
    }

    // Character card modal functions
    function showCharacterCard(character) {
      if (!character) return;
      
      characterName.textContent = character.roleName || character.name;
      characterType.textContent = `${character.type || 'Unknown'}-Type`;
      characterTeamBadge.textContent = character.team === 'good' ? 'üëº Good Team' : 'üòà Evil Team';
      characterTeamBadge.className = `character-team ${character.team}`;
      characterAbility.textContent = character.ability || character.short || 'No ability description available.';
      characterCard.className = `character-card ${character.team}`;
      
      characterModal.classList.add('active');
    }

    function hideCharacterCard(event) {
      // Close if clicking the backdrop (not the card itself)
      if (event.target === characterModal) {
        closeCharacterModal();
      }
    }

    function closeCharacterModal() {
      characterModal.classList.remove('active');
    }

    function updateTheme(themeName) {
      if (!THEMES[themeName]) {
        console.warn('Unknown theme:', themeName);
        return;
      }
      
      state.theme = themeName;
      applyThemeVisuals();
    }

    function applyThemeVisuals() {
      const theme = THEMES[state.theme];
      if (!theme) return;
      
      const visual = theme.visual;
      
      // Apply theme-specific background to body
      document.body.style.background = visual.background;
      
      // Apply theme font family
      document.body.style.fontFamily = visual.fontFamily;
      
      // Apply accent color to CSS variable
      document.documentElement.style.setProperty("--theme-accent", visual.accentColor);
      
      // Apply text glow to headers
      const headers = document.querySelectorAll("h1, h2");
      headers.forEach(header => {
        header.style.textShadow = visual.textGlow;
      });

      // Apply themed backgrounds to cards
      const phaseIndicator = document.querySelector(".phase-indicator");
      if (phaseIndicator) {
        phaseIndicator.style.backgroundColor = visual.cardBackground;
        phaseIndicator.style.borderColor = visual.accentColor;
        phaseIndicator.style.boxShadow = `0 0 60px ${visual.accentColor}80`;
      }

      const timerCard = document.querySelector(".timer-card");
      if (timerCard) {
        timerCard.style.backgroundColor = visual.cardBackground;
        timerCard.style.borderColor = `${visual.accentColor}40`;
      }

      const eliminatedCard = document.querySelector(".eliminated-card");
      if (eliminatedCard) {
        eliminatedCard.style.backgroundColor = visual.cardBackground;
      }

      // Apply animation to body if specified
      if (visual.animation && visual.animation !== "none") {
        document.body.style.animation = visual.animation;
      } else {
        document.body.style.animation = "none";
      }
    }

    function resetDisplay() {
      state.phase = 'setup';
      state.night = 0;
      state.timer = { remaining: 180, running: false };
      state.eliminated = [];
      state.theme = 'village';
      state.aliveCount = 0;
      state.goodCount = 0;
      state.evilCount = 0;
      state.voting = { active: false, phase: null, nominations: [] };
      state.roster = [];
      
      stopTimerDisplay();
      updatePhase('setup', 0);
      renderTimer();
      renderEliminated();
      applyThemeVisuals();
      hideWinNotification();
      updatePlayerCounts(0, 0, 0);
      updateVotingDisplay(false, null, []);
      updateRoster([]);
      closeCharacterModal();
      playerStats.style.display = 'none';
    }

    function updateConnectionStatus(connected) {
      state.connected = connected;
      
      if (connected) {
        connectionStatus.classList.remove('disconnected');
        connectionStatus.classList.add('connected');
        statusText.textContent = 'Connected';
      } else {
        connectionStatus.classList.remove('connected');
        connectionStatus.classList.add('disconnected');
        statusText.textContent = 'Waiting for Narrator';
      }
    }

    function showFallbackMessage() {
      nightNumber.textContent = 'Open this page from the Narrator View to sync automatically';
    }

    // Win notification display
    function showWinNotification(team, nightCount) {
      if (team === 'good') {
        winTitle.textContent = 'Good Team Wins!';
        winTitle.className = 'win-title good';
        winEmoji.textContent = 'üé≠ üèÜ üé≠';
        winSubtitle.textContent = `Victory after ${nightCount} nights!`;
      } else if (team === 'evil') {
        winTitle.textContent = 'Evil Team Wins!';
        winTitle.className = 'win-title evil';
        winEmoji.textContent = 'üòà üíÄ üòà';
        winSubtitle.textContent = `Darkness prevails after ${nightCount} nights!`;
      } else {
        // Invalid team value - ignore
        console.warn('Unknown team value:', team);
        return;
      }
      winOverlay.classList.add('active');
    }

    // Hide win notification
    function hideWinNotification() {
      winOverlay.classList.remove('active');
    }

    // Update player counts
    function updatePlayerCounts(alive, good, evil) {
      state.aliveCount = alive;
      state.goodCount = good;
      state.evilCount = evil;
      
      aliveCountEl.textContent = alive;
      goodCountEl.textContent = good;
      evilCountEl.textContent = evil;
      
      // Show/hide stats based on game phase
      if (state.phase !== 'setup') {
        playerStats.style.display = 'flex';
      }
    }

    // Update voting display
    function updateVotingDisplay(active, phase, nominations) {
      state.voting.active = active;
      state.voting.phase = phase;
      state.voting.nominations = nominations || [];
      
      if (active) {
        votingCard.classList.add('active');
        
        // Update phase label
        if (phase === 'nomination') {
          votingPhaseLabel.textContent = 'Accusation Phase';
          votingInstruction.textContent = 'Who do you suspect? Nominate the suspicious!';
        } else if (phase === 'defense') {
          votingPhaseLabel.textContent = 'Defense Phase';
          votingInstruction.textContent = 'The accused speak their truth...';
        } else if (phase === 'vote') {
          votingPhaseLabel.textContent = 'Vote Now!';
          votingInstruction.textContent = 'Point to the person you want to eliminate!';
        } else {
          votingPhaseLabel.textContent = 'Voting';
          votingInstruction.textContent = 'The village decides...';
        }
        
        // Update nominated list
        nominatedList.innerHTML = '';
        if (nominations && nominations.length > 0) {
          nominations.forEach(name => {
            const li = document.createElement('li');
            li.className = 'nominated-item';
            li.textContent = name;
            nominatedList.appendChild(li);
          });
        } else {
          const li = document.createElement('li');
          li.className = 'empty-message';
          li.textContent = 'No nominations yet';
          nominatedList.appendChild(li);
        }
      } else {
        votingCard.classList.remove('active');
      }
    }

    // Fullscreen toggle
    function toggleFullscreen() {
      if (!document.fullscreenElement) {
        document.documentElement.requestFullscreen().catch(err => {
          console.log('Fullscreen not available:', err);
        });
        // Button text updated by fullscreenchange event handler
      } else {
        document.exitFullscreen();
        // Button text updated by fullscreenchange event handler
      }
    }

    // Listen for fullscreen changes
    document.addEventListener('fullscreenchange', () => {
      if (document.fullscreenElement) {
        fullscreenBtn.textContent = '‚õ∂ Exit Fullscreen';
      } else {
        fullscreenBtn.textContent = '‚õ∂ Fullscreen';
      }
    });

    // Periodic connection check
    setInterval(() => {
      if (channel && state.connected) {
        // Keep connection alive by requesting state periodically
        channel.postMessage({ type: 'ping' });
      }
    }, 30000); // Every 30 seconds

    // Initialize
    document.addEventListener('DOMContentLoaded', () => {
      initBroadcastChannel();
      renderTimer();
      renderEliminated();
      applyThemeVisuals();
    });

    // Cleanup on unload
    window.addEventListener('beforeunload', () => {
      if (channel) {
        channel.close();
      }
      if (timerHandle) {
        clearInterval(timerHandle);
      }
    });
  </script>
</body>
</html>
